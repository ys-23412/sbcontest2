name: Scrap Sites Dev
on:
  workflow_dispatch:
  schedule:
    # 8:30 AM PST (16:30 UTC)
    # 12:30 PM PST (20:30 UTC)
    # 5:00 PM PST (01:00 UTC next day)
    # close enough
    - cron: '30 16,20,1 * * 6'
env:
    PY_COLORS: "1"
    DISPLAY: ":99"
    # Optional: PROXY_URL: ${{ steps.get_proxy.outputs.PROXY_URL }} if you re-enable proxy fetching
    BASE_DIR: "screenshots"
    GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
    YS_APIURL: ${{ secrets.YS_APIURL_DEV }} # Map YS_APIURL_DEV to YS_APIURL
    YS_COMPONENTID: 10
    HIDE_TINY_URL: True
    GH_WORKFLOW_NAME: ${{ github.workflow }}
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # JOB 1: Camofox Dev Tenders
  camofox-tenders:
    runs-on: ubuntu-latest
    # Job-specific Environment Variables
    env:
      EMAIL: ${{ secrets.TENDER_YS_EMAIL }}
      PASSWORD: ${{ secrets.TENDER_YS_PASSWORD }}
      TENDER_BASE_SAANICH_URL: ${{ secrets.TENDER_BASE_SAANICH_URL }}
      TENDER_BASE_BCTRANSIT_URL: ${{ secrets.TENDER_BASE_BCTRANSIT_URL }}
      TENDER_BASE_UVIC_URL: ${{ secrets.TENDER_BASE_UVIC_URL }}
      TENDER_BASE_NORTHCOW_URL: ${{ secrets.TENDER_BASE_NORTHCOW_URL }}
      TENDER_BASE_VIC_URL: ${{ secrets.TENDER_BASE_VIC_URL }}
      TENDER_BASE_CVRD_URL: ${{ secrets.TENDER_BASE_CVRD_URL }}
      TENDER_BASE_FNHA_URL: ${{ secrets.TENDER_BASE_FNHA_URL }}
      TENDER_BASE_COURTENAY_URL: ${{ secrets.TENDER_BASE_COURTENAY_URL }}
      TENDER_BASE_CENTRALSAANICH_URL: ${{ secrets.TENDER_BASE_CENTRALSAANICH_URL }}
      TENDER_BASE_FRASERHEALTH_URL: ${{ secrets.TENDER_BASE_FRASERHEALTH_URL }}
      TENDER_BASE_ICBC_URL: ${{ secrets.TENDER_BASE_ICBC_URL }}
      TENDER_BASE_PHSA_URL: ${{ secrets.TENDER_BASE_PHSA_URL }}
      TENDER_BASE_COMOX_URL: ${{ secrets.TENDER_BASE_COMOX_URL }}
      TENDER_BASE_ISLANDHEALTH_URL: ${{ secrets.TENDER_BASE_ISLANDHEALTH_URL }}
      TENDER_BASE_VIU_URL: ${{ secrets.TENDER_BASE_VIU_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update Pip Requirements
        run: |
          python -m pip install -r requirements.txt
          python -m pip install -r requirements_tenders.txt

      - name: Install Camoufox Dependencies
        run: |
          sudo apt install -y libgtk-3-0 libx11-xcb1 libasound2 || true
          pip install -U camoufox[geoip]
          pip install requests
          pip install camoufox-captcha

      - name: Retry to get camoufox
        uses: nick-fields/retry@v3
        with:
          max_attempts: 5
          timeout_seconds: 60
          command: python -m camoufox fetch

      - name: Fetch Tenders ALL
        run: python fetch_tenders_all.py

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: camofox-screenshots
          path: screenshots/
          retention-days: 3

      - name: Upload Data (Python Script)
        if: always()
        run: python upload_tenders.py

      - name: Validate Data
        if: always()
        run: python validate_tenders.py

      - name: Upload Results Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: camofox-data
          path: data/
          retention-days: 3

  # JOB 2: Dev Bids and Tenders
  bids-and-tenders:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install system dependencies (Chrome/Xvfb)
        run: |
          curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt update
          sudo apt install -y google-chrome-stable xvfb ffmpeg

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements_tenders.txt
          pip install playwright
          playwright install chromium

      - name: Run Browser Automation and Record Xvfb Session
        run: |
          mkdir -p video_recordings
          # Start Xvfb
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          sleep 2
          
          # Start FFmpeg recording
          ffmpeg -y -f x11grab -framerate 15 -video_size 1920x1080 -i :99.0 -c:v libx264 -preset medium -crf 28 -pix_fmt yuv420p "video_recordings/session.mp4" &
          FFMPEG_PID=$!
          
          # Run Script
          echo "Running process_bids_tenders.py..."
          python process_bids_tenders.py
          
          # Stop Recording
          kill -s SIGINT $FFMPEG_PID || true
          wait $FFMPEG_PID || true

          echo "Video recording completed: video_recordings/session.mp4"

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bids-screenshots
          path: screenshots/

      - name: Upload Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bids-data
          path: data/

      - name: Upload Video Recording
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xvfb-session-video
          path: video_recordings/session.mp4

  # JOB 3: Scrap CRD Website Dev
  scrape-crd-dev:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update
        run: |
          python -m pip install -r requirements.txt
          python -m pip install -r requirements_tenders.txt

      - name: Fetch Tenders ALL
        run: python bid_tenders.py

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crd-screenshots
          path: screenshots/
          retention-days: 3

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crd-data
          path: data/
          retention-days: 3

    # JOB 4 run test functions